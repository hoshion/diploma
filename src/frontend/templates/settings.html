{% extends 'base.html' %}
{% load static %}

{% block title %}Settings - News Analysis{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Settings</h2>

    <!-- Delete News Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Delete News Data</h5>
        </div>
        <div class="card-body">
            <form id="deleteNewsForm" class="row g-3">
                <div class="col-md-4">
                    <label for="deleteWebsite" class="form-label">Parser</label>
                    <select class="form-select" id="deleteWebsite" name="parser_name">
                        <option value="">All Parsers</option>
                        <option value="Hromadske">Hromadske</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="deleteStartDate" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="deleteStartDate" name="start_date" required>
                </div>
                <div class="col-md-4">
                    <label for="deleteEndDate" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="deleteEndDate" name="end_date" required>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete all news data within this date range? This action cannot be undone.')">
                        Delete News Data
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Existing Settings Content -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Parser Settings</h5>
        </div>
        <div class="card-body">
            <div class="settings-container">
                <button class="btn btn-secondary back-button">‚Üê Back to Visualization</button>
                
                <div class="settings-section">
                    <h3>News Parsing Settings</h3>
                    <div class="form-group col-md-4">
                        <label for="parse_start_year">Start Year:</label>
                        <input class="form-control" type="number" id="parse_start_year" min="2000" max="2100">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="parse_end_year">End Year:</label>
                        <input class="form-control" type="number" id="parse_end_year" min="2000" max="2100">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="parse_start_month">Start Month:</label>
                        <input class="form-control" type="number" id="parse_start_month" min="1" max="12">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="parse_end_month">End Month:</label>
                        <input class="form-control" type="number" id="parse_end_month" min="1" max="12">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="parser_type">Parser Type:</label>
                        <select class="form-select" id="parser_type">
                            <option value="Hromadske">Hromadske</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="startParsingBtn">Start Parsing</button>
                </div>

                <div class="settings-section">
                    <h3>Translation Settings</h3>
                    <div class="form-group col-md-4">
                        <label for="translate_start_year">Start Year:</label>
                        <input class="form-control" type="number" id="translate_start_year" min="2000" max="2100">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="translate_end_year">End Year:</label>
                        <input class="form-control" type="number" id="translate_end_year" min="2000" max="2100">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="translate_start_month">Start Month:</label>
                        <input class="form-control" type="number" id="translate_start_month" min="1" max="12">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="translate_end_month">End Month:</label>
                        <input class="form-control" type="number" id="translate_end_month" min="1" max="12">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="translator_type">Translator Type:</label>
                        <select class="form-select" id="translator_type">
                            <option value="Google">Google</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="translate_parser_type">Parser Type:</label>
                        <select class="form-select" id="translate_parser_type">
                            <option value="Hromadske">Hromadske</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="startTranslationBtn">Start Translation</button>
                </div>

                <div class="settings-section">
                    <h3>Analysis Settings</h3>
                    <div class="form-group col-md-4">
                        <label for="analyze_start_year">Start Year:</label>
                        <input class="form-control" type="number" id="analyze_start_year" min="2000" max="2100">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="analyze_end_year">End Year:</label>
                        <input class="form-control" type="number" id="analyze_end_year" min="2000" max="2100">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="analyze_start_month">Start Month:</label>
                        <input class="form-control" type="number" id="analyze_start_month" min="1" max="12">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="analyze_end_month">End Month:</label>
                        <input class="form-control" type="number" id="analyze_end_month" min="1" max="12">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="analyze_translator_type">Translator Type:</label>
                        <select class="form-select" id="analyze_translator_type">
                            <option value="Google">Google</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="analyze_parser_type">Parser Type:</label>
                        <select class="form-select" id="analyze_parser_type">
                            <option value="Hromadske">Hromadske</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="model_type">Model Type:</label>
                        <select class="form-select" id="model_type">
                            <option value="llama3.1:8b">Llama 3.1 8B</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="prompt">Prompt:</label>
                        <textarea class="form-control" id="prompt" rows="4" style="width: 100%;"></textarea>
                    </div>
                    <button class="btn btn-primary" id="startSentimentBtn">Start Sentiment Analysis</button>
                    <button class="btn btn-primary" id="startClusteringBtn">Start Clustering</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('deleteNewsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = {
        parser_name: formData.get('parser_name'),
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date')
    };
    fetch('/api/news/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the news data.');
    });
});

// Remove all inline onclick handlers and add event listeners for the following buttons
window.addEventListener('DOMContentLoaded', function() {
    document.querySelector('.back-button').addEventListener('click', function() {
        window.location.href = '/';
    });
    document.getElementById('startParsingBtn').addEventListener('click', function() {
        startParsing();
    });
    document.getElementById('startTranslationBtn').addEventListener('click', function() {
        startTranslation();
    });
    document.getElementById('startSentimentBtn').addEventListener('click', function() {
        startSentimentAnalysis();
    });
    document.getElementById('startClusteringBtn').addEventListener('click', function() {
        startClustering();
    });
});

// Function to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function startParsing() {
    try {
        const params = {
            start_year: document.getElementById('parse_start_year').value,
            end_year: document.getElementById('parse_end_year').value,
            start_month: document.getElementById('parse_start_month').value,
            end_month: document.getElementById('parse_end_month').value,
            parser_type: document.getElementById('parser_type').value
        };
        
        const response = await fetch('/api/news/parse/?' + new URLSearchParams(params));
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to start parsing');
        }
        
        alert('Parsing started successfully');
    } catch (error) {
        alert('Error starting parsing: ' + error.message);
    }
}

async function startTranslation() {
    try {
        const params = {
            start_year: document.getElementById('translate_start_year').value,
            end_year: document.getElementById('translate_end_year').value,
            start_month: document.getElementById('translate_start_month').value,
            end_month: document.getElementById('translate_end_month').value,
            translator_type: document.getElementById('translator_type').value,
            parser_type: document.getElementById('translate_parser_type').value
        };
        
        const response = await fetch('/api/news/translate/?' + new URLSearchParams(params));
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to start translation');
        }
        
        alert('Translation started successfully');
    } catch (error) {
        alert('Error starting translation: ' + error.message);
    }
}

async function startSentimentAnalysis() {
    try {
        const params = {
            start_year: +document.getElementById('analyze_start_year').value,
            end_year: +document.getElementById('analyze_end_year').value,
            start_month: +document.getElementById('analyze_start_month').value,
            end_month: +document.getElementById('analyze_end_month').value,
            translator_type: document.getElementById('analyze_translator_type').value,
            parser_type: document.getElementById('analyze_parser_type').value,
            model_type: document.getElementById('model_type').value,
            prompt: document.getElementById('prompt').value
        };
        
        const response = await fetch('/api/news/sentiment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(params)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to start sentiment analysis');
        }
        
        alert('Sentiment analysis started successfully');
    } catch (error) {
        alert('Error starting sentiment analysis: ' + error.message);
    }
}

async function startClustering() {
    try {
        const params = {
            start_year: +document.getElementById('analyze_start_year').value,
            end_year: +document.getElementById('analyze_end_year').value,
            start_month: +document.getElementById('analyze_start_month').value,
            end_month: +document.getElementById('analyze_end_month').value,
            translator_type: document.getElementById('analyze_translator_type').value,
            parser_type: document.getElementById('analyze_parser_type').value,
            model_type: document.getElementById('model_type').value,
            prompt: document.getElementById('prompt').value
        };
        
        const response = await fetch('/api/news/clusterize/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(params)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to start clustering');
        }
        
        alert('Clustering started successfully');
    } catch (error) {
        alert('Error starting clustering: ' + error.message);
    }
}
</script>
{% endblock %}

{% block extra_css %}
<style>
.settings-container {
    margin-top: 20px;
}
.settings-section {
    margin-bottom: 32px;
    padding: 24px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.settings-section h3 {
    margin-bottom: 18px;
    color: #333;
}
.form-group {
    margin-bottom: 14px;
}
.back-button {
    margin-bottom: 18px;
    font-size: 1rem;
    padding: 6px 18px;
    border-radius: 6px;
}
</style>
{% endblock %} 